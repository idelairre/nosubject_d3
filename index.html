<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>D3 test</title>
    <script src='http://d3js.org/d3.v3.min.js'></script>
</head>
<body>
  <script type="text/javascript" charset="utf-8">
      console.log('initialized');

      var width = 960, height = 960;

      var labelDistance = 0;

      var vis = d3.select('body')
                  .append('svg:svg')
                  .attr('width', width)
                  .attr('height', height);

      // data for graph 1
      // signature: { label: <String> }
      var nodes = [];

      // { source: <nodeArrayPos>, target: <nodeArrayPos>, weight: <number> }
      var links = [];

      // data for graph 2
      // object signature: { node: { source: <nodeArrayPos>, target: <nodeArrayPos>, weight: <number> } };
      var labelAnchors = [];
      var labelAnchorLinks = [];

      // generate objects from saved json
      // first read articles.json

      for (var i = 0; i < data.length; i += 1) {
        var node = {
          label: data[i].title
        };

        nodes.push(node);
        labelAnchors.push({ node : node });
        labelAnchors.push({ node : node });
      }

      for (var i = 0; i < nodes.length; i += 1) {
        for (var j = 0; j < i; j += 1) {
            links.push({
              source : i,
              target : j,
              weight : 1
            });
          }
        // need a clever way of calculating this...
        labelAnchorLinks.push({
          source : i * 2,
          target : i * 2 + 1,
          weight : 1
        });
      }
      console.log('nodes: ', nodes);
      console.log('labelAnchors', labelAnchors);
      console.log('labelAnchorLinks: ', labelAnchorLinks);
      console.log('links: ', links);

      var force = d3.layout.force()
                    .size([width, height])
                    .nodes(nodes)
                    .links(links)
                    .gravity(1)
                    .linkDistance(50)
                    .charge(-3000)
                    .linkStrength(function (x) {
                      return x.weight * 10
                    });

      force.start();

      // graph that displays labels
      var force2 = d3.layout.force()
                      .nodes(labelAnchors)
                      .links(labelAnchorLinks)
                      .gravity(0)
                      .linkDistance(0)
                      .linkStrength(8)
                      .charge(-100)
                      .size([width, height]);

      force2.start();

      var link = vis.selectAll('line.link')
                    .data(links)
                    .enter()
                    .append('svg:line')
                    .attr('class', 'link')
                    .style('stroke', '#CCC');

      var node = vis.selectAll('g.node')
                    .data(force.nodes())
                    .enter()
                    .append('svg:g')
                    .attr('class', 'node');

      node.append('svg:circle')
          .attr('r', 5)
          .style('fill', '#555')
          .style('stroke', '#FFF')
          .style('stroke-width', 3);

      node.call(force.drag);

      var anchorLink = vis.selectAll('line.anchorLink')
                          .data(labelAnchorLinks)
                          .enter()
                          .append('svg:line')
                          // .attr('class', 'anchorLink')
                          // .style('stroke', '#999');

      var anchorNode = vis.selectAll('g.anchorNode')
                          .data(force2.nodes())
                          .enter()
                          .append('svg:g')
                          .attr('class', 'anchorNode');

      anchorNode.append('svg:circle')
                .attr('r', 0)
                .style('fill', '#FFF');

      anchorNode.append('svg:text')
                .text(function (datum, index) {
                    return index % 2 == 0 ? "" : datum.node.label;
                });

      anchorNode.style('fill', '#555')
                .style('font-family', 'Arial')
                .style('font-size', 12);

      var updateLink = function () {
        this.attr('x1', function (datum) {
          return datum.source.x;
        }).attr('y1', function (datum) {
          return datum.source.y;
        }).attr('x2', function (datum) {
          return datum.target.x;
        }).attr('y2', function (datum) {
          return datum.target.y;
        });
      }

      var updateNode = function () {
        this.attr('transform', function (datum) {
          return 'translate(' + datum.x + ", " + datum.y + ')';
        });
      }

      force.on('tick', function () {
        force2.start();

        node.call(updateNode);

        anchorNode.each(function (datum, index) {
          if (index % 2 == 0) {
            datum.x = datum.node.x;
            datum.y = datum.node.y;
          } else {
            var b = this.childNodes[1].getBBox();

            var diffX = datum.x - datum.node.x; // wat?
            var diffY = datum.y - datum.node.y

            var dist = Math.sqrt(diffX * diffX + diffY * diffY);

            var shiftX = b.width * (diffX - dist) / (dist * 2);
            shiftX = Math.max(-b.width, Math.min(0, shiftX));
            var shiftY = 5;
            this.childNodes[1].setAttribute('transform', 'translate(' + shiftX + ',' + shiftY + ')');
          }
        });

        anchorNode.call(updateNode);

        link.call(updateLink);
        anchorLink.call(updateLink);

      });
    </script>
</body>
</html>
